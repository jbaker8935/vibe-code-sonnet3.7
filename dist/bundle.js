!function(){"use strict";function e(e,t,o){let n=!1;for(let r=0;r<ROWS;r++){for(let a=0;a<COLS;a++)if(e[r][a]&&e[r][a].player===t){const t=calculateLegalMovesForState(e,r,a);for(const l of t){const t=cloneBoard(e),c=t[r][a],i=t[l.row][l.col];if(i?(t[l.row][l.col]={...c,state:SWAPPED},t[r][a]={...i,state:SWAPPED}):(t[l.row][l.col]={...c},t[r][a]=null,unmarkSwapped(t)),!allowsOpponentWin(t,o,"easy")){n=!0;break}}if(n)break}if(n)break}return!n}window.ROWS=8,window.COLS=4,window.PLAYER_A="A",window.PLAYER_B="B",window.NORMAL="normal",window.SWAPPED="swapped",window.NUM_DIRECTIONS=8,window.JS_DIRECTIONS=[{dr:-1,dc:-1},{dr:-1,dc:0},{dr:-1,dc:1},{dr:0,dc:-1},{dr:0,dc:1},{dr:1,dc:-1},{dr:1,dc:0},{dr:1,dc:1}],window.initialPosition=["BBBB\nBBBB\n....\n....\n....\n....\nAAAA\nAAAA","....\n....\nBBBB\nBBBB\nAAAA\nAAAA\n....\n....","BB..\nBB..\nBB..\nBB..\n..AA\n..AA\n..AA\n..AA","B...\nBB..\nBB..\nBBB.\n.AAA\n..AA\n..AA\n...A","B..B\n.BB.\n.BB.\nB..B\nA..A\n.AA.\n.AA.\nA..A","....\n....\nBABA\nABAB\nBABA\nABAB\n....\n...."],window.parseStartingPosition=function(e){const t=Array(ROWS).fill(null).map((()=>Array(COLS).fill(null))),o=e.split("\n");for(let e=0;e<ROWS;e++)for(let n=0;n<COLS;n++){const r=o[e][n];"A"===r?t[e][n]={player:PLAYER_A,state:NORMAL}:"B"===r?t[e][n]={player:PLAYER_B,state:NORMAL}:"a"===r?t[e][n]={player:PLAYER_A,state:SWAPPED}:"b"===r&&(t[e][n]={player:PLAYER_B,state:SWAPPED})}return t},window.cloneBoard=function(e){return"function"==typeof structuredClone?structuredClone(e):JSON.parse(JSON.stringify(e))},window.serializeBoardState=function(e){return e.map((e=>e.map((e=>e?`${e.player}${e.state===NORMAL?"N":"S"}`:"_")).join(""))).join("|")},window.boardToKey=function(e){return e.map((e=>e.map((e=>e?`${e.player}${e.state[0]}`:"_")).join(""))).join("|")},window.convertBoardToBinaryJS=function(e){let t=0,o=0,n=0,r=0,a=0;for(let l=0;l<ROWS;l++)for(let c=0;c<COLS;c++){const i=l*COLS+c,s=e[l][c];null===s?t|=1<<i:s.player===PLAYER_A?s.state===NORMAL?o|=1<<i:n|=1<<i:s.player===PLAYER_B&&(s.state===NORMAL?r|=1<<i:a|=1<<i)}return[t>>>0,o>>>0,n>>>0,r>>>0,a>>>0]},window.getPieceImage=function(e,t){return`images/${e===PLAYER_A?"white":"black"}_${t===NORMAL?"normal":"swapped"}.png`},window.renderBoard=function({board:e,selectedPiece:t,legalMoves:o,gameOver:n,winner:r,winPath:a,moveHistory:l,currentHistoryIndex:c,playerAScore:i,playerBScore:s,boardElement:d,currentPlayer:u,showWinPath:w}){d.innerHTML="",d.classList.remove("game-over");for(let l=0;l<ROWS;l++)for(let c=0;c<COLS;c++){const i=document.createElement("div");i.classList.add("cell"),i.dataset.row=l,i.dataset.col=c,i.classList.add((l+c)%2==0?"light":"dark");const s=e[l][c];if(s){const e=document.createElement("img");e.classList.add("piece"),e.src=getPieceImage(s.player,s.state),e.alt=`Player ${s.player} ${s.state}`,i.appendChild(e)}t&&t.row===l&&t.col===c&&i.classList.add("selected"),o&&o.some((e=>e.row===l&&e.col===c))&&(i.classList.add("legal-move"),e[l][c]&&e[l][c].player!==u&&i.classList.add("swap-target")),w&&n&&r&&a&&a.some((e=>e.row===l&&e.col===c))&&i.classList.add("win-path"),d.appendChild(i)}if(n){if(d.classList.add("game-over"),void 0!==c){const e=document.createElement("div");e.classList.add("move-counter"),e.textContent=c===l.length?"Final Position":`Move ${c} of ${l.length}`,d.appendChild(e)}const e=document.createElement("div");e.classList.add("score-display"),e.innerHTML=`\n            <div id="score-a">Player A: ${i}</div>\n            <div id="score-b">Player B: ${s}</div>\n        `,d.appendChild(e)}},window.getBoardElement=function(){return document.getElementById("game-board")},window.getScoreElements=function(){return{controlScoreA:document.getElementById("control-score-a"),controlScoreB:document.getElementById("control-score-b"),scoreA:document.getElementById("score-a"),scoreB:document.getElementById("score-b")}},window.selectPiece=function(e,t,o,n){return{selectedPiece:{row:e,col:t},legalMoves:calculateLegalMoves(e,t,o,n)}},window.deselectPiece=function(){return{selectedPiece:null,legalMoves:[]}},window.calculateLegalMoves=function(e,t,o,n){const r=[],a=o[e][t];if(!a)return r;const l=a.player===PLAYER_A?PLAYER_B:PLAYER_A;for(let n=-1;n<=1;n++)for(let a=-1;a<=1;a++){if(0===n&&0===a)continue;const c=e+n,i=t+a;if(c>=0&&c<ROWS&&i>=0&&i<COLS){const e=o[c][i];null===e?r.push({row:c,col:i}):e.player===l&&e.state===NORMAL&&r.push({row:c,col:i,isSwap:!0})}}return r},window.makeMove=function(e,t,o,n,r,a,l,c){if(!a||e!==a.row||t!==a.col)throw new Error("Move error: Invalid start piece.");if(!l.find((e=>e.row===o&&e.col===n)))throw new Error("Move error: Invalid target cell.");const i=r[e][t],s=r[o][n];return null===s?(r[o][n]=i,r[e][t]=null,unmarkSwapped(r)):(r[o][n]={...i,state:SWAPPED},r[e][t]={...s,state:SWAPPED}),r},window.unmarkSwapped=function(e){for(let t=0;t<ROWS;t++)for(let o=0;o<COLS;o++)e[t][o]&&e[t][o].state===SWAPPED&&(e[t][o].state=NORMAL)},window.switchPlayer=function(e){return e===PLAYER_A?PLAYER_B:PLAYER_A},window.checkWinCondition=function(e,t){const o=t===PLAYER_A?ROWS-2:1,n=t===PLAYER_A?1:ROWS-2,r=Array(ROWS).fill(null).map((()=>Array(COLS).fill(!1))),a=[];for(let n=0;n<COLS;n++)e[o]&&e[o][n]&&e[o][n].player===t&&(a.push({row:o,col:n,path:[{row:o,col:n}]}),r[o][n]=!0);for(;a.length>0;){const o=a.shift(),{row:l,col:c,path:i}=o;if(l===n)return{win:!0,path:i};for(let o=-1;o<=1;o++)for(let n=-1;n<=1;n++){if(0===o&&0===n)continue;const s=l+o,d=c+n;s>=0&&s<ROWS&&d>=0&&d<COLS&&!r[s][d]&&e[s]&&e[s][d]&&e[s][d].player===t&&(r[s][d]=!0,a.push({row:s,col:d,path:[...i,{row:s,col:d}]}))}}return{win:!1,path:[]}},window.boardToNNInput=function(e,t=PLAYER_B){const o=ROWS*COLS,n=6*o,r=new Float32Array(n);for(let e=0;e<n;e++)r[e]=0;for(let t=0;t<ROWS;t++)for(let n=0;n<COLS;n++){const a=t*COLS+n,l=e[t][n];l?l.player===PLAYER_A?l.state===NORMAL?r[a]=1:r[o+a]=1:l.state===NORMAL?r[2*o+a]=1:r[3*o+a]=1:r[4*o+a]=1}const a=t===PLAYER_A?0:1;for(let e=0;e<o;e++)r[5*o+e]=a;return r},window.neuralNetworkPredict=async function(e,t){if(!e)throw new Error("TensorFlow model not loaded");if(!t||192!==t.length)throw new Error(`Invalid NN input: expected 192 elements, got ${t?.length}`);let o,n;try{o=tf.tensor2d([t]);const r=e.inputs[0].name;if(n=e.execute({[r]:o}),n.length<2)throw new Error(`Expected 2 output tensors (value, policy), got ${n.length}`);const a=n[0],l=n[1],c=l.shape,i=a.shape;256!==c[1]&&console.error(`ERROR: Policy tensor has wrong shape [${c}], expected [1, 256]`),1!==i[1]&&console.error(`ERROR: Value tensor has wrong shape [${i}], expected [1, 1]`);const s=a.arraySync(),d=l.arraySync(),u=s[0][0],w=d[0];return o.dispose(),n.forEach((e=>e.dispose())),{value:u,policy:w}}catch(e){throw o&&!o.isDisposed&&o.dispose(),n&&n.forEach((e=>{e&&!e.isDisposed&&e.dispose()})),e}},window.initializeMCTS=function(MCTSSearch,SwitcharooGameLogic,e){if(void 0!==MCTSSearch&&void 0!==SwitcharooGameLogic){const t=new SwitcharooGameLogic({ROWS:ROWS,COLS:COLS,PLAYER_A:PLAYER_A,PLAYER_B:PLAYER_B,NORMAL:NORMAL,SWAPPED:SWAPPED,NUM_DIRECTIONS:NUM_DIRECTIONS,JS_DIRECTIONS:JS_DIRECTIONS});return{mctsSearch:new MCTSSearch({numSimulations:e.MCTS_SIMULATIONS,cPuct:e.MCTS_PUCT_CONSTANT,temperature:e.MCTS_TEMPERATURE,dirichletAlpha:e.MCTS_DIRICHLET_ALPHA,dirichletEpsilon:e.MCTS_DIRICHLET_EPSILON,enabled:e.MCTS_ENABLED,verbose:e.MCTS_VERBOSE,logSearchStats:!0}),gameLogic:t}}return{mctsSearch:null,gameLogic:null}},window.showOverlay=function(e){e&&e.classList.add("active")},window.hideOverlay=function(e){e&&e.classList.remove("active")},window.hideAllOverlays=function(){document.querySelectorAll(".overlay").forEach((e=>e.classList.remove("active")))},window.moveToActionIndex=function(e){const t=e.start.row*COLS+e.start.col,o=e.end.row-e.start.row,n=e.end.col-e.start.col;let r=-1;for(let e=0;e<JS_DIRECTIONS.length;e++)if(JS_DIRECTIONS[e].dr===o&&JS_DIRECTIONS[e].dc===n){r=e;break}if(-1===r)return console.error("Could not find direction for move:",JSON.stringify(e)),null;const a=t*NUM_DIRECTIONS+r;return a<0||a>=256?(console.error(`INVALID ACTION INDEX: ${a} for move (${e.start.row},${e.start.col}) â†’ (${e.end.row},${e.end.col})`),console.error(`  Details: startCell=${t}, direction=${r}, dr=${o}, dc=${n}`),null):a},window.calculateLegalMovesForState=function(e,t,o){const n=[],r=e[t][o];if(!r)return n;for(const a of JS_DIRECTIONS){const l=t+a.dr,c=o+a.dc;if(l>=0&&l<ROWS&&c>=0&&c<COLS){const t=e[l][c];t?t.player!==r.player&&t.state===NORMAL&&n.push({row:l,col:c,isSwap:!0}):n.push({row:l,col:c,isSwap:!1})}}return n},window.canWinInOneMove=function(e,t){for(let o=0;o<ROWS;o++)for(let n=0;n<COLS;n++)if(e[o][n]&&e[o][n].player===t){const r=calculateLegalMovesForState(e,o,n);for(const a of r){const r=cloneBoard(e),l=r[o][n],c=r[a.row][a.col];c?(r[a.row][a.col]={...l,state:SWAPPED},r[o][n]={...c,state:SWAPPED}):(r[a.row][a.col]={...l},r[o][n]=null,unmarkSwapped(r));const i=checkWinCondition(r,t);if(i.win)return{canWin:!0,winningMove:{start:{row:o,col:n},end:{row:a.row,col:a.col},isSwap:!!c},winResult:i}}}return{canWin:!1}},window.allowsOpponentWin=function(t,o,n="hard1"){if(canWinInOneMove(t,o).canWin)return!0;if("easy"===n)return!1;if("hard1"===n||"hard_ai"===n){const n=o===PLAYER_A?PLAYER_B:PLAYER_A;for(let r=0;r<ROWS;r++)for(let a=0;a<COLS;a++)if(t[r][a]&&t[r][a].player===o){const l=calculateLegalMovesForState(t,r,a);for(const c of l){const l=cloneBoard(t),i=l[r][a],s=l[c.row][c.col];if(s?(l[c.row][c.col]={...i,state:SWAPPED},l[r][a]={...s,state:SWAPPED}):(l[c.row][c.col]={...i},l[r][a]=null,unmarkSwapped(l)),e(l,n,o))return logBoardForDebug(t),logBoardForDebug(l),!0}}}return!1},window.evaluateBoardState=function(e,t,o=null){let n=0,r=new Map;for(let o=0;o<ROWS;o++)for(let a=0;a<COLS;a++){const l=e[o][a];if(l&&l.player===t){if(o>=1&&o<=6&&r.set(o,!0),Math.random()<.5){const e=Math.abs(a-Math.floor(COLS/2));n+=Math.max(0,3-e)}n+=countFriendlyNeighbors(e,o,a,t)}}return n+=10*r.size,n},window.countFriendlyNeighbors=function(e,t,o,n){let r=0;for(const a of JS_DIRECTIONS){const l=t+a.dr,c=o+a.dc;if(l>=0&&l<ROWS&&c>=0&&c<COLS){const t=e[l][c];t&&t.player===n&&r++}}return Math.min(r,2)},window.checkWinConditionForState=function(e,t){return checkWinCondition(e,t)},window.findBestAIMove=async function e(t,o=PLAYER_B,n="hard_ai",r=1,a=!1,l=!1,c=50,i=null,s=null,d=null){let u=[];for(let e=0;e<ROWS;e++)for(let n=0;n<COLS;n++)if(t[e][n]&&t[e][n].player===o){calculateLegalMovesForState(t,e,n).forEach((t=>{u.push({start:{row:e,col:n},end:{row:t.row,col:t.col},isSwap:!!t.isSwap})}))}if(0===u.length)return null;for(const e of u){const n=cloneBoard(t),{start:r,end:l}=e,c=n[r.row][r.col],i=n[l.row][l.col];if(i?(n[l.row][l.col]={...c,state:SWAPPED},n[r.row][r.col]={...i,state:SWAPPED}):(n[l.row][l.col]={...c},n[r.row][r.col]=null,unmarkSwapped(n)),checkWinConditionForState(n,o).win)return a,e}if("hard_ai"===n){if(!i)return console.warn("Neural network model not available. Falling back to heuristic AI (hard1)."),await e(t,o,"hard1",r,a,l,c,i,s,d);if(l&&s&&d)try{const e=async e=>await neuralNetworkPredict(i,e),r=await s.search(t,o,e,d),l=[];for(let e=0;e<ROWS;e++)for(let n=0;n<COLS;n++)if(t[e][n]&&t[e][n].player===o){calculateLegalMovesForState(t,e,n).forEach((t=>{l.push({start:{row:e,col:n},end:{row:t.row,col:t.col},isSwap:!!t.isSwap})}))}if(l.length>0){const e=o===PLAYER_A?PLAYER_B:PLAYER_A,c=l.filter((o=>{const r=cloneBoard(t),{start:a,end:l}=o,c=r[a.row][a.col],i=r[l.row][l.col];return i?(r[l.row][l.col]={...c,state:SWAPPED},r[a.row][a.col]={...i,state:SWAPPED}):(r[l.row][l.col]={...c},r[a.row][a.col]=null,unmarkSwapped(r)),!allowsOpponentWin(r,e,n)}));let i=null,s=-1;const d=c.length>0?c:l;for(const e of d){const t=moveToActionIndex(e);if(null!==t&&t>=0&&t<r.length){const o=r[t];o>s&&(s=o,i=e)}}if(i&&a&&0===c.length&&console.warn("All MCTS moves allow opponent win; forced to pick among losing moves."),i)return i}}catch(e){console.error("Error during MCTS move selection:",e)}const w=o===PLAYER_A?PLAYER_B:PLAYER_A;let m=[],f=null,A=-1/0;for(const e of u){const r=cloneBoard(t),{start:a,end:l}=e,c=r[a.row][a.col],i=r[l.row][l.col];i?(r[l.row][l.col]={...c,state:SWAPPED},r[a.row][a.col]={...i,state:SWAPPED}):(r[l.row][l.col]={...c},r[a.row][a.col]=null,unmarkSwapped(r));const s=evaluateBoardState(r,o);!allowsOpponentWin(r,w,n)&&m.push({move:e,score:s}),s>A&&(A=s,f=e)}if(m.length>0){const e=Math.max(...m.map((e=>e.score))),t=m.filter((t=>t.score===e));f=t[Math.floor(Math.random()*t.length)].move}else a;return f}if("hard1"===n||"easy"===n){let e=[];const r=o===PLAYER_A?PLAYER_B:PLAYER_A;for(const a of u){const l=cloneBoard(t),{start:c,end:i}=a,s=l[c.row][c.col],d=l[i.row][i.col];d?(l[i.row][i.col]={...s,state:SWAPPED},l[c.row][c.col]={...d,state:SWAPPED}):(l[i.row][i.col]={...s},l[c.row][c.col]=null,unmarkSwapped(l));let u=!1;if(("easy"===n||"hard1"===n)&&(u=!allowsOpponentWin(l,r,n)),u){const t=evaluateBoardState(l,o);e.push({move:a,score:t})}}if(a,e.length>0){let t=Math.max(...e.map((e=>e.score))),o=e.filter((e=>e.score===t)).map((e=>e.move));"easy"===n&&a;const r=o[Math.floor(Math.random()*o.length)];return r&&a,r}{let e=u.map((e=>{const n=cloneBoard(t),{start:r,end:a}=e,l=n[r.row][r.col],c=n[a.row][a.col];return c?(n[a.row][a.col]={...l,state:SWAPPED},n[r.row][r.col]={...c,state:SWAPPED}):(n[a.row][a.col]={...l},n[r.row][r.col]=null,unmarkSwapped(n)),{move:e,score:evaluateBoardState(n,o)}})),r=Math.max(...e.map((e=>e.score))),l=e.filter((e=>e.score===r)).map((e=>e.move));"easy"===n&&a;const c=l[Math.floor(Math.random()*l.length)];return c&&a,c}}return null},window.logBoardForDebug=function(e){let t="";for(let o=0;o<ROWS;o++){let n="";for(let t=0;t<COLS;t++){const r=e[o][t];if(r){const e=r.player===PLAYER_A?"A":"B";n+=r.state===SWAPPED?e.toLowerCase():e}else n+="."}t+=n+"\n"}};const t="\nA..B\n...B\nAAB.\nA..B\n..BB\nA.BB\nAAA.\n....".trim(),o={row:2,col:1},n={row:2,col:2},r=PLAYER_A;function a(e){for(let t=0;t<ROWS;t++){let o=`${t}: `;for(let n=0;n<COLS;n++){const r=e[t][n];if(r){const e=r.player===PLAYER_A?"A":"B";o+=(r.state===NORMAL?e:e.toLowerCase())+" "}else o+=". "}}}window.runBoardPositionTest=async function(){if("undefined"!=typeof window&&"undefined"!=typeof tf){let e=0;for(;!window.tfModel&&e<100;)await new Promise((e=>setTimeout(e,100))),e++;window.tfModel}const e=parseStartingPosition(t);a(e);const l=checkWinCondition(e,PLAYER_A),c=checkWinCondition(e,PLAYER_B);if(l.win||c.win)return console.error("ERROR: Game already over in initial position!"),!1;!function(e){const t=cloneBoard(e),l=t[o.row][o.col];if(!l)return null;if(l.player!==r)return null;if(n.row<0||n.row>=ROWS||n.col<0||n.col>=COLS)return null;if(t[n.row][n.col]&&t[n.row][n.col].player===l.player)return null;const c=t[n.row][n.col];if(c)t[n.row][n.col]={...l,state:SWAPPED},t[o.row][o.col]={...c,state:SWAPPED};else{t[n.row][n.col]={...l},t[o.row][o.col]=null;for(let e=0;e<ROWS;e++)for(let o=0;o<COLS;o++)t[e][o]&&t[e][o].state===SWAPPED&&(t[e][o].state=NORMAL)}a(t);const i=r===PLAYER_A?PLAYER_B:PLAYER_A,s=canWinInOneMove(t,i);if(s.canWin)return t}(e);return await async function(e){const t=[];for(let o=0;o<ROWS;o++)for(let n=0;n<COLS;n++){const r=e[o][n];if(r&&r.player===PLAYER_B)for(let r=-1;r<=1;r++)for(let a=-1;a<=1;a++){if(0===r&&0===a)continue;const l=o+r,c=n+a;if(l>=0&&l<ROWS&&c>=0&&c<COLS){const r=e[l][c];r?r.player===PLAYER_A&&r.state===NORMAL&&t.push({start:{row:o,col:n},end:{row:l,col:c},type:"swap"}):t.push({start:{row:o,col:n},end:{row:l,col:c},type:"empty"})}}}t.slice(0,10).forEach(((e,t)=>{}));let o=0,n=0;for(let r=0;r<Math.min(t.length,15);r++){const a=t[r],l=cloneBoard(e),c=l[a.start.row][a.start.col],i=l[a.end.row][a.end.col];if("empty"===a.type){l[a.end.row][a.end.col]={...c},l[a.start.row][a.start.col]=null;for(let e=0;e<ROWS;e++)for(let t=0;t<COLS;t++)l[e][t]&&l[e][t].state===SWAPPED&&(l[e][t].state=NORMAL)}else l[a.end.row][a.end.col]={...c,state:SWAPPED},l[a.start.row][a.start.col]={...i,state:SWAPPED};canWinInOneMove(l,PLAYER_A).canWin?n++:o++}}(e),await async function(e){try{const t="undefined"!=typeof window&&"undefined"!=typeof tf,o=t?["easy","hard1","hard_ai"]:["easy","hard1"];!t;for(const n of o){"hard_ai"===n&&window.tfModel;const o=await findBestAIMove(e,PLAYER_B,n,2,!0,!1,50,t?window.tfModel:null,null,null);if(o){const t=cloneBoard(e),n=t[o.start.row][o.start.col],r=t[o.end.row][o.end.col];if(r)t[o.end.row][o.end.col]={...n,state:SWAPPED},t[o.start.row][o.start.col]={...r,state:SWAPPED};else{t[o.end.row][o.end.col]={...n},t[o.start.row][o.start.col]=null;for(let e=0;e<ROWS;e++)for(let o=0;o<COLS;o++)t[e][o]&&t[e][o].state===SWAPPED&&(t[e][o].state=NORMAL)}canWinInOneMove(t,PLAYER_A).canWin}}!t}catch(e){console.error("Error testing AI move selection:",e)}}(e),!0};let l,c=[],i=PLAYER_A,s=null,d=[],u=[],w=!1,m=null,f=[],A=0,y=0,S=null,p=0,E=!1,h=null,P=null,v="easy",g=!1,L=!1,B=50,O=.1,R=.25,M=!1,I=null,C=null,_=!1;window.analysisMode=g;const b=document.getElementById("game-board"),W=document.getElementById("reset-btn"),T=document.getElementById("info-btn"),N=document.getElementById("history-btn"),Y=document.getElementById("start-btn"),k=document.getElementById("info-overlay"),D=document.getElementById("history-overlay"),x=document.getElementById("win-overlay"),H=document.getElementById("history-list"),$=document.getElementById("win-message"),F=document.querySelectorAll(".close-overlay-btn"),j=document.querySelectorAll(".overlay"),J=(document.getElementById("ai-spinner-overlay"),document.getElementById("mcts-btn")),U=document.getElementById("mcts-overlay");function z(){"undefined"!=typeof MCTSSearch&&"undefined"!=typeof SwitcharooGameLogic?(C=new SwitcharooGameLogic({ROWS:ROWS,COLS:COLS,PLAYER_A:PLAYER_A,PLAYER_B:PLAYER_B,NORMAL:NORMAL,SWAPPED:SWAPPED,NUM_DIRECTIONS:NUM_DIRECTIONS,JS_DIRECTIONS:JS_DIRECTIONS}),I=new MCTSSearch({numSimulations:B,cPuct:1,temperature:O,dirichletAlpha:.3,dirichletEpsilon:R,enabled:L,verbose:M,logSearchStats:!0}),window.mctsSearch=I,window.gameLogic=C,console.log("MCTS initialized with settings:",{numSimulations:B,cPuct:1,temperature:O,dirichletAlpha:.3,dirichletEpsilon:R,enabled:L,verbose:M})):(console.warn("MCTS classes not available - MCTS features disabled"),window.mctsSearch=null,window.gameLogic=null)}function G(){E&&se(),S=parseStartingPosition(initialPosition[p]),c=S.map((e=>e.map((e=>e?{...e}:null)))),i=PLAYER_A,s=null,d=[],u=[],w=!1,m=null,f=[],N.disabled=!0,renderBoard({board:c,selectedPiece:s,legalMoves:d,gameOver:w,winner:m,winPath:f,moveHistory:u,currentHistoryIndex:l,playerAScore:A,playerBScore:y,boardElement:b,currentPlayer:i}),hideAllOverlays(),_&&0===u.length&&(i=PLAYER_B,setTimeout((async()=>{await oe(),i=PLAYER_A,renderBoard({board:c,selectedPiece:s,legalMoves:d,gameOver:w,winner:m,winPath:f,moveHistory:u,currentHistoryIndex:l,playerAScore:A,playerBScore:y,boardElement:b,currentPlayer:i})}),300))}function q(){const e=document.getElementById("control-score-a"),t=document.getElementById("control-score-b");e&&(e.textContent=`${A}`),t&&(t.textContent=`${y}`);const o=document.getElementById("score-a"),n=document.getElementById("score-b");o&&n&&(o.textContent=`Player A: ${A}`,n.textContent=`Player B: ${y}`)}function V(e){if(!w)return;void 0===l&&(l=u.length);const t=Math.max(0,Math.min(u.length,l+e));if(t!==l){if(l=t,l===u.length)ce({board:c,selectedPiece:s,legalMoves:d,gameOver:w,winner:m,winPath:f,moveHistory:u,currentHistoryIndex:l,playerAScore:A,playerBScore:y,boardElement:b,currentPlayer:i});else if(0===l){ce({board:S.map((e=>e.map((e=>e?{...e}:null)))),selectedPiece:null,legalMoves:[],gameOver:w,winner:m,winPath:f,moveHistory:u,currentHistoryIndex:l,playerAScore:A,playerBScore:y,boardElement:b,currentPlayer:i})}else ce({board:u[l-1].boardAfter,selectedPiece:null,legalMoves:[],gameOver:w,winner:m,winPath:f,moveHistory:u,currentHistoryIndex:l,playerAScore:A,playerBScore:y,boardElement:b,currentPlayer:i});K()}}function K(){if(!w)return;let e=document.querySelector(".move-counter");e||(e=document.createElement("div"),e.classList.add("move-counter"),b.appendChild(e)),e.textContent=void 0===l||l===u.length?"Final Position":`Move ${l} of ${u.length}`}function X(e,t,o,n,r){u.push({player:e,start:{...t},end:{...o},boardBefore:cloneBoard(n),boardAfter:cloneBoard(r)})}!async function(){if("undefined"!=typeof tf){const e=Object.keys(tf.engine().registryFactory);if(e.includes("webgl"))try{await tf.setBackend("webgl"),console.log("TensorFlow.js using WebGL backend for best performance")}catch(e){console.warn("WebGL backend failed, falling back to alternatives:",e)}else if(e.includes("wasm"))try{await tf.setBackend("wasm"),console.log("TensorFlow.js using WASM backend for improved CPU performance")}catch(e){console.warn("WASM backend failed, falling back to CPU:",e),await tf.setBackend("cpu"),console.log("TensorFlow.js using CPU backend")}else await tf.setBackend("cpu");await tf.ready()}else console.warn("tf object not available at the time of setting backend.")}(),document.addEventListener("DOMContentLoaded",(async()=>{z(),await new Promise((e=>setTimeout(e,500)));try{await async function(e=3e4){const t=Date.now();let o=0;for(;"undefined"==typeof tf;){if(o++,Date.now()-t>e)throw console.error(`TensorFlow.js failed to load within ${e}ms timeout after ${o} attempts`),new Error("TensorFlow.js failed to load within timeout");o%10==0,await new Promise((e=>setTimeout(e,200)))}return!0}();await async function(){try{if("undefined"==typeof tf)throw new Error("TensorFlow.js not available yet");let e;await tf.ready();try{e=await tf.loadGraphModel("./switcharoo_tfjs_model/model.json")}catch(e){throw console.error("Error during tf.loadGraphModel:",e),console.error("Model load error type:",e.constructor.name),console.error("Model load error message:",e.message),console.error("Model load error stack:",e.stack),e}P=e;try{const e=tf.zeros([1,192]),t=P.inputs[0].name,o=P.execute({[t]:e});e.dispose(),Array.isArray(o)?o.forEach((e=>e.dispose())):o.dispose()}catch(e){console.warn("Model test failed:",e),console.warn("Proceeding anyway as model loaded successfully")}return window.tfModel=P,!0}catch(e){return console.error("=== Model Loading Failed ==="),console.error("Could not load pre-trained graph model. Error object:",e),console.error("Error type:",e.constructor.name),console.error("Error message:",e.message),console.error("Error stack:",e.stack),console.warn("The Neural Network AI option will be disabled as it requires pre-trained weights to work properly."),P=null,window.tfModel=null,!1}}()}catch(e){console.warn("Failed to wait for TensorFlow.js or load model:",e),console.warn("Error details:",e.message,e.stack),window.tfModel=null}const e=document.getElementById("ai-plays-first");e&&(e.checked=_,e.addEventListener("change",(()=>{_=e.checked}))),G()})),W.addEventListener("click",(()=>{p=0,G()})),T.addEventListener("click",(()=>showOverlay(k))),N.addEventListener("click",(()=>{N.disabled||(!function(){if(H.innerHTML="",0===u.length)return H.textContent="No moves made yet.",void 0;for(let e=u.length-1;e>=0;e--){const t=u[e],o=e+1,n=ROWS-t.start.row,r=ROWS-t.end.row,a=String.fromCharCode("A".charCodeAt(0)+t.start.col),c=String.fromCharCode("A".charCodeAt(0)+t.end.col),s=document.createElement("div");s.textContent=`${o}. Player ${t.player}: ${a}${n} â†’ ${c}${r}`,s.classList.add("history-move"),l===o&&s.classList.add("selected-move"),s.addEventListener("click",(()=>{l=o,t.boardAfter?ce({board:t.boardAfter,selectedPiece:null,legalMoves:[],gameOver:w,winner:m,winPath:f,moveHistory:u,currentHistoryIndex:l,playerAScore:A,playerBScore:y,boardElement:b,currentPlayer:i}):console.warn("No boardAfter for move",o),K(),hideOverlay(D)})),H.appendChild(s)}const e=document.createElement("div");e.textContent="0. Initial State",e.classList.add("history-move"),0===l&&e.classList.add("selected-move"),e.addEventListener("click",(()=>{const e=S.map((e=>e.map((e=>e?{...e}:null))));l=0,ce({board:e,selectedPiece:null,legalMoves:[],gameOver:w,winner:m,winPath:f,moveHistory:u,currentHistoryIndex:l,playerAScore:A,playerBScore:y,boardElement:b,currentPlayer:i}),K(),hideOverlay(D)})),H.insertBefore(e,H.firstChild)}(),showOverlay(D))})),Y.addEventListener("click",(()=>{p=(p+1)%initialPosition.length,G()})),F.forEach((e=>{e.addEventListener("click",(async()=>{const t=e.getAttribute("data-overlay"),o=document.getElementById(t);hideOverlay(o),"mcts-overlay"===t&&void 0!==_&&_&&Array.isArray(u)&&0===u.length&&void 0!==i&&i===PLAYER_A&&(i=PLAYER_B,await oe(),i=PLAYER_A,renderBoard({board:c,selectedPiece:s,legalMoves:d,gameOver:w,winner:m,winPath:f,moveHistory:u,currentHistoryIndex:l,playerAScore:A,playerBScore:y,boardElement:b,currentPlayer:i}))}))})),j.forEach((e=>{e.addEventListener("click",(t=>{t.target===e&&hideOverlay(e)}))})),J&&U&&J.addEventListener("click",(()=>{showOverlay(U)}));const Q=document.getElementById("ai-difficulty-select");function Z(){const e=document.querySelectorAll(".mcts-only");Q&&"hard_ai"===Q.value?(e.forEach((e=>e.style.display="")),L=!0):(e.forEach((e=>e.style.display="none")),L=!1),ee()}function ee(){const e=document.getElementById("mcts-enabled"),t=document.getElementById("mcts-simulations"),o=document.getElementById("mcts-simulations-value"),n=document.getElementById("mcts-temperature"),r=document.getElementById("mcts-temperature-value");e&&(e.checked=L),t&&(t.value=B),o&&(o.textContent=B),n&&(n.value=O),r&&(r.textContent=O.toFixed(2))}function te(){const e=document.getElementById("mcts-btn"),t=e?.querySelector("img");if(t)switch(Q.value){case"easy":default:t.src="images/happy-outline.svg";break;case"hard1":t.src="images/hardware-chip-outline.svg";break;case"hard_ai":t.src="images/skull-outline.svg"}}async function oe(){if(w)return;const e=await findBestAIMove(c,i,v,1,window.analysisMode,L,B,P,I,C);if(e){const t=cloneBoard(c);c=makeMove(e.start.row,e.start.col,e.end.row,e.end.col,c,e.start,[e.end],i),X(i,e.start,e.end,t,c);const o=checkWinCondition(c,PLAYER_A),n=checkWinCondition(c,PLAYER_B);o.win||n.win?(w=!0,m=o.win&&n.win?"both":o.win?PLAYER_A:PLAYER_B,f=o.win?o.path:n.path,m===PLAYER_A?A++:m===PLAYER_B&&y++,x&&$&&($.textContent="both"===m?"Both players win simultaneously!":`Player ${m===PLAYER_A?"A":"B"} wins!`,showOverlay(x)),N&&(N.disabled=!1)):i=switchPlayer(i),ce({board:c,selectedPiece:s,legalMoves:d,gameOver:w,winner:m,winPath:f,moveHistory:u,currentHistoryIndex:l,playerAScore:A,playerBScore:y,boardElement:b,currentPlayer:i}),q()}else i=switchPlayer(i),ce({board:c,selectedPiece:s,legalMoves:d,gameOver:w,winner:m,winPath:f,moveHistory:u,currentHistoryIndex:l,playerAScore:A,playerBScore:y,boardElement:b,currentPlayer:i}),q()}Q&&(Q.addEventListener("change",(()=>{v=Q.value,Z()})),Z()),document.addEventListener("DOMContentLoaded",(()=>{!function(){const e=document.getElementById("mcts-simulations"),t=document.getElementById("mcts-simulations-value"),o=document.getElementById("mcts-temperature"),n=document.getElementById("mcts-temperature-value"),r=document.getElementById("mcts-enabled"),a=document.getElementById("mcts-reset-defaults");e&&t&&e.addEventListener("input",(e=>{const o=parseInt(e.target.value);B=Math.max(1,Math.min(200,o)),t.textContent=B,I&&I.setNumSimulations(B)})),o&&n&&o.addEventListener("input",(e=>{const t=parseFloat(e.target.value);O=Math.max(0,Math.min(2,t)),n.textContent=O.toFixed(2),I&&I.setTemperature(O)})),r&&r.addEventListener("change",(e=>{Q&&"hard_ai"===Q.value?(L=e.target.checked,I&&I.setEnabled(L)):(e.target.checked=!1,L=!1)})),a&&a.addEventListener("click",(()=>{L=!0,B=50,O=.1,M=!1,ee(),z()}))}(),ee()})),Q&&(Q.addEventListener("change",te),te()),b&&b.addEventListener("click",(e=>{const t=e.target.closest(".cell");if(!t)return;const o=parseInt(t.dataset.row,10),n=parseInt(t.dataset.col,10);if(!isNaN(o)&&!isNaN(n)&&!w&&!E&&(i!==PLAYER_B||E))if(s)if(d.some((e=>e.row===o&&e.col===n))){const e=cloneBoard(c);c=makeMove(s.row,s.col,o,n,c,s,d,i),X(i,s,{row:o,col:n},e,c),s=null,d=[];const t=checkWinCondition(c,PLAYER_A),r=checkWinCondition(c,PLAYER_B);t.win||r.win?(w=!0,m=t.win&&r.win?"both":t.win?PLAYER_A:PLAYER_B,f=t.win?t.path:r.path,m===PLAYER_A?A++:m===PLAYER_B&&y++,x&&$&&($.textContent="both"===m?"Both players win simultaneously!":`Player ${m===PLAYER_A?"A":"B"} wins!`,showOverlay(x)),N&&(N.disabled=!1)):(i=switchPlayer(i),i!==PLAYER_B||E||setTimeout(oe,100)),ce({board:c,selectedPiece:s,legalMoves:d,gameOver:w,winner:m,winPath:f,moveHistory:u,currentHistoryIndex:l,playerAScore:A,playerBScore:y,boardElement:b,currentPlayer:i}),q()}else o===s.row&&n===s.col?(s=null,d=[],ce({board:c,selectedPiece:s,legalMoves:d,gameOver:w,winner:m,winPath:f,moveHistory:u,currentHistoryIndex:l,playerAScore:A,playerBScore:y,boardElement:b,currentPlayer:i})):c[o][n]&&c[o][n].player===i?(s={row:o,col:n},d=calculateLegalMoves(o,n,c,i),ce({board:c,selectedPiece:s,legalMoves:d,gameOver:w,winner:m,winPath:f,moveHistory:u,currentHistoryIndex:l,playerAScore:A,playerBScore:y,boardElement:b,currentPlayer:i})):(s=null,d=[],ce({board:c,selectedPiece:s,legalMoves:d,gameOver:w,winner:m,winPath:f,moveHistory:u,currentHistoryIndex:l,playerAScore:A,playerBScore:y,boardElement:b,currentPlayer:i}));else c[o][n]&&c[o][n].player===i&&(s={row:o,col:n},d=calculateLegalMoves(o,n,c,i),ce({board:c,selectedPiece:s,legalMoves:d,gameOver:w,winner:m,winPath:f,moveHistory:u,currentHistoryIndex:l,playerAScore:A,playerBScore:y,boardElement:b,currentPlayer:i}))})),b.addEventListener("wheel",(e=>{if(!w)return;e.preventDefault();V(e.deltaY>0?-1:1)}));let ne=null;b.addEventListener("touchstart",(e=>{w&&1===e.touches.length&&(ne=e.touches[0].clientY)})),b.addEventListener("touchend",(e=>{if(!w||null===ne)return;const t=e.changedTouches[0].clientY-ne;if(Math.abs(t)>30){V(t<0?1:-1)}ne=null}));var re=!0,ae=console.log;console.log=function(){re,ae.apply(this,arguments)};var le=console.warn;function ce(e){renderBoard({...e,showWinPath:void 0===l||l===u.length,boardElement:b})}async function ie(){if(void 0!==l&&l>0){const e=u[l-1].boardAfter,t=u[l-1].player===PLAYER_A?PLAYER_B:PLAYER_A;g=!0;await findBestAIMove(e,t,v,1,!0,L,B,P,I,C);g=!1}}function se(){E=!1,h&&(clearTimeout(h),h=null)}function de(){if(!E||w)return;h=setTimeout((()=>{!async function(){if(!E||w)return;try{await oe(),!w&&E?de():w&&se()}catch(e){console.error("Error during self-play move:",e),se()}}()}),500)}console.warn=function(){re,le.apply(this,arguments)},window.SwitcharooGlobals={board:c,currentPlayer:i,selectedPiece:s,legalMoves:d,moveHistory:u,gameOver:w,winner:m,winPath:f,playerAScore:A,playerBScore:y,currentHistoryIndex:l,startingPosition:S,startingPositionIndex:p,isInSelfPlay:E,selfPlayTimeoutId:h,tfModel:P,AI_DIFFICULTY:v,AI_DEPTH:1,ANALYSIS_MODE:g,MCTS_ENABLED:L,MCTS_SIMULATIONS:B,MCTS_TEMPERATURE:O,MCTS_PUCT_CONSTANT:1,MCTS_DIRICHLET_ALPHA:.3,MCTS_DIRICHLET_EPSILON:R,MCTS_VERBOSE:M,mctsSearch:I,gameLogic:C,parseStartingPosition:parseStartingPosition,cloneBoard:cloneBoard,serializeBoardState:serializeBoardState,boardToKey:boardToKey,convertBoardToBinaryJS:convertBoardToBinaryJS,renderBoard:renderBoard,getPieceImage:getPieceImage,selectPiece:selectPiece,deselectPiece:deselectPiece,calculateLegalMoves:calculateLegalMoves,makeMove:makeMove,unmarkSwapped:unmarkSwapped,switchPlayer:switchPlayer,checkWinCondition:checkWinCondition,boardToNNInput:boardToNNInput,neuralNetworkPredict:neuralNetworkPredict,initializeMCTS:z,showOverlay:showOverlay,hideOverlay:hideOverlay,hideAllOverlays:hideAllOverlays,initGame:G,findBestAIMove:findBestAIMove,moveToActionIndex:moveToActionIndex,calculateLegalMovesForState:calculateLegalMovesForState,allowsOpponentWin:allowsOpponentWin,evaluateBoardState:evaluateBoardState,countFriendlyNeighbors:countFriendlyNeighbors,checkWinConditionForState:checkWinConditionForState,analyzeHistoricalMove:ie,startSelfPlay:function(){if(w)return;E=!0,de()},stopSelfPlay:se},window.analyzeHistoricalMove=ie,window.printBoardState=function(){return void 0===c?(console.warn("Global board variable is not defined."),void 0):(logBoardForDebug(c),c)}}();