!function(){"use strict";function e(){const e=[];for(let t=0;t<ROWS;t++){const t=[];for(let e=0;e<COLS;e++)t.push(null);e.push(t)}return e}function t(e,t,o){let n=!1;for(let r=0;r<ROWS;r++){for(let a=0;a<COLS;a++)if(e[r][a]&&e[r][a].player===t){const t=calculateLegalMovesForState(e,r,a);for(const l of t){const t=cloneBoard(e),c=t[r][a],i=t[l.row][l.col];if(i?(t[l.row][l.col]={...c,state:SWAPPED},t[r][a]={...i,state:SWAPPED}):(t[l.row][l.col]={...c},t[r][a]=null,unmarkSwapped(t)),!allowsOpponentWin(t,o,"easy")){n=!0;break}}if(n)break}if(n)break}return!n}window.ROWS=8,window.COLS=4,window.PLAYER_A="A",window.PLAYER_B="B",window.NORMAL="normal",window.SWAPPED="swapped",window.NUM_DIRECTIONS=8,window.JS_DIRECTIONS=[{dr:-1,dc:-1},{dr:-1,dc:0},{dr:-1,dc:1},{dr:0,dc:-1},{dr:0,dc:1},{dr:1,dc:-1},{dr:1,dc:0},{dr:1,dc:1}],window.initialPosition=["BBBB\nBBBB\n....\n....\n....\n....\nAAAA\nAAAA","....\n....\nBBBB\nBBBB\nAAAA\nAAAA\n....\n....","BB..\nBB..\nBB..\nBB..\n..AA\n..AA\n..AA\n..AA","B...\nBB..\nBB..\nBBB.\n.AAA\n..AA\n..AA\n...A","B..B\n.BB.\n.BB.\nB..B\nA..A\n.AA.\n.AA.\nA..A","....\n....\nBABA\nABAB\nBABA\nABAB\n....\n...."],window.parseStartingPosition=function(e){const t=Array(ROWS).fill(null).map((()=>Array(COLS).fill(null))),o=e.split("\n");for(let e=0;e<ROWS;e++)for(let n=0;n<COLS;n++){const r=o[e][n];"A"===r?t[e][n]={player:PLAYER_A,state:NORMAL}:"B"===r?t[e][n]={player:PLAYER_B,state:NORMAL}:"a"===r?t[e][n]={player:PLAYER_A,state:SWAPPED}:"b"===r&&(t[e][n]={player:PLAYER_B,state:SWAPPED})}return t},window.cloneBoard=function(e){return"function"==typeof structuredClone?structuredClone(e):JSON.parse(JSON.stringify(e))},window.serializeBoardState=function(e){return e.map((e=>e.map((e=>e?`${e.player}${e.state===NORMAL?"N":"S"}`:"_")).join(""))).join("|")},window.boardToKey=function(e){return e.map((e=>e.map((e=>e?`${e.player}${e.state[0]}`:"_")).join(""))).join("|")},window.convertBoardToBinaryJS=function(e){let t=0,o=0,n=0,r=0,a=0;for(let l=0;l<ROWS;l++)for(let c=0;c<COLS;c++){const i=l*COLS+c,s=e[l][c];null===s?t|=1<<i:s.player===PLAYER_A?s.state===NORMAL?o|=1<<i:n|=1<<i:s.player===PLAYER_B&&(s.state===NORMAL?r|=1<<i:a|=1<<i)}return[t>>>0,o>>>0,n>>>0,r>>>0,a>>>0]},window.getPieceImage=function(e,t){return`images/${e===PLAYER_A?"white":"black"}_${t===NORMAL?"normal":"swapped"}.png`},window.renderBoard=function({board:e,selectedPiece:t,legalMoves:o,gameOver:n,winner:r,winPath:a,moveHistory:l,currentHistoryIndex:c,playerAScore:i,playerBScore:s,boardElement:d,currentPlayer:u,showWinPath:w}){d.innerHTML="",d.classList.remove("game-over");for(let l=0;l<ROWS;l++)for(let c=0;c<COLS;c++){const i=document.createElement("div");i.classList.add("cell"),i.dataset.row=l,i.dataset.col=c,i.classList.add((l+c)%2==0?"light":"dark");const s=e[l][c];if(s){const e=document.createElement("img");e.classList.add("piece"),e.src=getPieceImage(s.player,s.state),e.alt=`Player ${s.player} ${s.state}`,i.appendChild(e)}t&&t.row===l&&t.col===c&&i.classList.add("selected"),o&&o.some((e=>e.row===l&&e.col===c))&&(i.classList.add("legal-move"),e[l][c]&&e[l][c].player!==u&&i.classList.add("swap-target")),w&&n&&r&&a&&a.some((e=>e.row===l&&e.col===c))&&i.classList.add("win-path"),d.appendChild(i)}if(n){if(d.classList.add("game-over"),void 0!==c){const e=document.createElement("div");e.classList.add("move-counter"),e.textContent=c===l.length?"Final Position":`Move ${c} of ${l.length}`,d.appendChild(e)}const e=document.createElement("div");e.classList.add("score-display"),e.innerHTML=`\n            <div id="score-a">Player A: ${i}</div>\n            <div id="score-b">Player B: ${s}</div>\n        `,d.appendChild(e)}},window.getBoardElement=function(){return document.getElementById("game-board")},window.getScoreElements=function(){return{controlScoreA:document.getElementById("control-score-a"),controlScoreB:document.getElementById("control-score-b"),scoreA:document.getElementById("score-a"),scoreB:document.getElementById("score-b")}},window.selectPiece=function(e,t,o,n){return{selectedPiece:{row:e,col:t},legalMoves:calculateLegalMoves(e,t,o,n)}},window.deselectPiece=function(){return{selectedPiece:null,legalMoves:[]}},window.calculateLegalMoves=function(e,t,o,n){const r=[],a=o[e][t];if(!a)return r;const l=a.player===PLAYER_A?PLAYER_B:PLAYER_A;for(let n=-1;n<=1;n++)for(let a=-1;a<=1;a++){if(0===n&&0===a)continue;const c=e+n,i=t+a;if(c>=0&&c<ROWS&&i>=0&&i<COLS){const e=o[c][i];null===e?r.push({row:c,col:i}):e.player===l&&e.state===NORMAL&&r.push({row:c,col:i,isSwap:!0})}}return r},window.makeMove=function(e,t,o,n,r,a,l,c){if(!a||e!==a.row||t!==a.col)throw new Error("Move error: Invalid start piece.");if(!l.find((e=>e.row===o&&e.col===n)))throw new Error("Move error: Invalid target cell.");const i=r[e][t],s=r[o][n];return null===s?(r[o][n]=i,r[e][t]=null,unmarkSwapped(r)):(r[o][n]={...i,state:SWAPPED},r[e][t]={...s,state:SWAPPED}),r},window.unmarkSwapped=function(e){for(let t=0;t<ROWS;t++)for(let o=0;o<COLS;o++)e[t][o]&&e[t][o].state===SWAPPED&&(e[t][o].state=NORMAL)},window.switchPlayer=function(e){return e===PLAYER_A?PLAYER_B:PLAYER_A},window.checkWinCondition=function(e,t){const o=t===PLAYER_A?ROWS-2:1,n=t===PLAYER_A?1:ROWS-2,r=Array(ROWS).fill(null).map((()=>Array(COLS).fill(!1))),a=[];for(let n=0;n<COLS;n++)e[o]&&e[o][n]&&e[o][n].player===t&&(a.push({row:o,col:n,path:[{row:o,col:n}]}),r[o][n]=!0);for(;a.length>0;){const o=a.shift(),{row:l,col:c,path:i}=o;if(l===n)return{win:!0,path:i};for(let o=-1;o<=1;o++)for(let n=-1;n<=1;n++){if(0===o&&0===n)continue;const s=l+o,d=c+n;s>=0&&s<ROWS&&d>=0&&d<COLS&&!r[s][d]&&e[s]&&e[s][d]&&e[s][d].player===t&&(r[s][d]=!0,a.push({row:s,col:d,path:[...i,{row:s,col:d}]}))}}return{win:!1,path:[]}},window.boardToNNInput=function(t,o=PLAYER_B){const n=[];for(let e=0;e<ROWS;e++){n[e]=[];for(let t=0;t<COLS;t++)n[e][t]=new Array(18).fill(0)}for(let r=0;r<3;r++){const a=t&&t[r]?t[r]:e();for(let e=0;e<ROWS;e++)for(let t=0;t<COLS;t++){const l=a[e][t];let c=6*r;l?l.player===PLAYER_A?l.state===NORMAL?n[e][t][c+0]=1:n[e][t][c+1]=1:l.player===PLAYER_B&&(l.state===NORMAL?n[e][t][c+2]=1:n[e][t][c+3]=1):n[e][t][c+4]=1,2===r&&(n[e][t][c+5]=o===PLAYER_B?1:0)}}return n},window.neuralNetworkPredict=async function(e,t){if(!e)throw new Error("TensorFlow model not loaded");if(!t||8!==t.length||4!==t[0].length||18!==t[0][0].length)throw new Error(`Invalid NN input: expected [8,4,18], got ${JSON.stringify([t?.length,t?.[0]?.length,t?.[0]?.[0]?.length])}`);let o;try{o=tf.tensor([t],[1,8,4,18]);const n=e.predict(o);let r,a;if(Array.isArray(n))[r,a]=n;else{if(!n.policy_output||!n.value_output)throw new Error("Unexpected model output format");r=n.policy_output,a=n.value_output}const l=(await r.data())[0]?Array.from(await r.data()):Array.from(await r.arraySync())[0],c=(await a.data())[0]?Array.from(await a.data()):Array.from(await a.arraySync())[0];return o.dispose(),r.dispose&&r.dispose(),a.dispose&&a.dispose(),{value:c[0],policy:l}}catch(e){throw o&&!o.isDisposed&&o.dispose(),e}},window.initializeMCTS=function(MCTSSearch,SwitcharooGameLogic,e){if(void 0!==MCTSSearch&&void 0!==SwitcharooGameLogic){const t=new SwitcharooGameLogic({ROWS:ROWS,COLS:COLS,PLAYER_A:PLAYER_A,PLAYER_B:PLAYER_B,NORMAL:NORMAL,SWAPPED:SWAPPED,NUM_DIRECTIONS:NUM_DIRECTIONS,JS_DIRECTIONS:JS_DIRECTIONS});return{mctsSearch:new MCTSSearch({numSimulations:e.MCTS_SIMULATIONS,cPuct:e.MCTS_PUCT_CONSTANT,temperature:e.MCTS_TEMPERATURE,dirichletAlpha:e.MCTS_DIRICHLET_ALPHA,dirichletEpsilon:e.MCTS_DIRICHLET_EPSILON,enabled:e.MCTS_ENABLED,verbose:e.MCTS_VERBOSE,logSearchStats:!0}),gameLogic:t}}return{mctsSearch:null,gameLogic:null}},window.showOverlay=function(e){e&&e.classList.add("active")},window.hideOverlay=function(e){e&&e.classList.remove("active")},window.hideAllOverlays=function(){document.querySelectorAll(".overlay").forEach((e=>e.classList.remove("active")))},window.moveToActionIndex=function(e){const t=e.start.row*COLS+e.start.col,o=e.end.row-e.start.row,n=e.end.col-e.start.col;let r=-1;for(let e=0;e<JS_DIRECTIONS.length;e++)if(JS_DIRECTIONS[e].dr===o&&JS_DIRECTIONS[e].dc===n){r=e;break}if(-1===r)return console.error("Could not find direction for move:",JSON.stringify(e)),null;const a=t*NUM_DIRECTIONS+r;return a<0||a>=256?(console.error(`INVALID ACTION INDEX: ${a} for move (${e.start.row},${e.start.col}) → (${e.end.row},${e.end.col})`),console.error(`  Details: startCell=${t}, direction=${r}, dr=${o}, dc=${n}`),null):a},window.calculateLegalMovesForState=function(e,t,o){const n=[],r=e[t][o];if(!r)return n;for(const a of JS_DIRECTIONS){const l=t+a.dr,c=o+a.dc;if(l>=0&&l<ROWS&&c>=0&&c<COLS){const t=e[l][c];t?t.player!==r.player&&t.state===NORMAL&&n.push({row:l,col:c,isSwap:!0}):n.push({row:l,col:c,isSwap:!1})}}return n},window.canWinInOneMove=function(e,t){for(let o=0;o<ROWS;o++)for(let n=0;n<COLS;n++)if(e[o][n]&&e[o][n].player===t){const r=calculateLegalMovesForState(e,o,n);for(const a of r){const r=cloneBoard(e),l=r[o][n],c=r[a.row][a.col];c?(r[a.row][a.col]={...l,state:SWAPPED},r[o][n]={...c,state:SWAPPED}):(r[a.row][a.col]={...l},r[o][n]=null,unmarkSwapped(r));const i=checkWinCondition(r,t);if(i.win)return{canWin:!0,winningMove:{start:{row:o,col:n},end:{row:a.row,col:a.col},isSwap:!!c},winResult:i}}}return{canWin:!1}},window.allowsOpponentWin=function(e,o,n="hard1"){if(canWinInOneMove(e,o).canWin)return!0;if("easy"===n)return!1;if("hard1"===n||"hard_ai"===n){const n=o===PLAYER_A?PLAYER_B:PLAYER_A;for(let r=0;r<ROWS;r++)for(let a=0;a<COLS;a++)if(e[r][a]&&e[r][a].player===o){const l=calculateLegalMovesForState(e,r,a);for(const c of l){const l=cloneBoard(e),i=l[r][a],s=l[c.row][c.col];if(s?(l[c.row][c.col]={...i,state:SWAPPED},l[r][a]={...s,state:SWAPPED}):(l[c.row][c.col]={...i},l[r][a]=null,unmarkSwapped(l)),t(l,n,o))return logBoardForDebug(e),logBoardForDebug(l),!0}}}return!1},window.logBoardForDebug=function(e){let t="";for(let o=0;o<ROWS;o++){let n="";for(let t=0;t<COLS;t++){const r=e[o][t];if(r){const e=r.player===PLAYER_A?"A":"B";n+=r.state===SWAPPED?e.toLowerCase():e}else n+="."}t+=n+"\n"}},window.evaluateBoardState=function(e,t,o=null){let n=0,r=new Map;for(let o=0;o<ROWS;o++)for(let a=0;a<COLS;a++){const l=e[o][a];if(l&&l.player===t){if(o>=1&&o<=6&&r.set(o,!0),Math.random()<.5){const e=Math.abs(a-Math.floor(COLS/2));n+=Math.max(0,3-e)}n+=countFriendlyNeighbors(e,o,a,t)}}return n+=10*r.size,n},window.countFriendlyNeighbors=function(e,t,o,n){let r=0;for(const a of JS_DIRECTIONS){const l=t+a.dr,c=o+a.dc;if(l>=0&&l<ROWS&&c>=0&&c<COLS){const t=e[l][c];t&&t.player===n&&r++}}return Math.min(r,2)},window.checkWinConditionForState=function(e,t){return checkWinCondition(e,t)},window.findBestAIMove=async function e(t,o=PLAYER_B,n="hard_ai",r=1,a=!1,l=!1,c=50,i=null,s=null,d=null,u=null){let w=[];for(let e=0;e<ROWS;e++)for(let n=0;n<COLS;n++)if(t[e][n]&&t[e][n].player===o){calculateLegalMovesForState(t,e,n).forEach((t=>{w.push({start:{row:e,col:n},end:{row:t.row,col:t.col},isSwap:t.isSwap})}))}if(0===w.length)return null;for(const e of w){const n=cloneBoard(t),{start:r,end:l}=e,c=n[r.row][r.col],i=n[l.row][l.col];if(i?(n[l.row][l.col]={...c,state:SWAPPED},n[r.row][r.col]={...i,state:SWAPPED}):(n[l.row][l.col]={...c},n[r.row][r.col]=null,unmarkSwapped(n)),checkWinConditionForState(n,o).win)return a,e}const f=function(e,t){const o=[];for(e&&e.length>=2&&o.push(e[e.length-2].boardAfter),e&&e.length>=1&&o.push(e[e.length-1].boardAfter);o.length<2;)o.unshift(null);return o.push(t),o}(u,t);if("hard_ai"===n){if(!i)return console.warn("Neural network model not available. Falling back to heuristic AI (hard1).\n"),await e(t,o,"hard1",r,a,l,c,i,s,d,u);if(l&&s&&d){const e=async e=>await neuralNetworkPredict(i,e),r=await s.search(t,o,e,d,f),l=[];for(let e=0;e<ROWS;e++)for(let n=0;n<COLS;n++)if(t[e][n]&&t[e][n].player===o){calculateLegalMovesForState(t,e,n).forEach((t=>{l.push({start:{row:e,col:n},end:{row:t.row,col:t.col},isSwap:t.isSwap})}))}if(l.length>0){const e=o===PLAYER_A?PLAYER_B:PLAYER_A,c=l.filter((o=>{const r=cloneBoard(t),{start:a,end:l}=o,c=r[a.row][a.col],i=r[l.row][l.col];return i?(r[l.row][l.col]={...c,state:SWAPPED},r[a.row][a.col]={...i,state:SWAPPED}):(r[l.row][l.col]={...c},r[a.row][a.col]=null,unmarkSwapped(r)),!allowsOpponentWin(r,e,n)}));let i=null,s=-1;const d=c.length>0?c:l;for(const e of d){const t=moveToActionIndex(e);null!==t&&r[t]>s&&(s=r[t],i=e)}if(i&&a,i)return i}}const A=boardToNNInput(f,o),{policy:y}=await neuralNetworkPredict(i,A);let m=null,p=-1;for(const e of w){const t=moveToActionIndex(e);null!==t&&y[t]>p&&(p=y[t],m=e)}if(m)return m}let A=null,y=-1/0;const m=o===PLAYER_A?PLAYER_B:PLAYER_A;for(const e of w){const r=cloneBoard(t),{start:a,end:l}=e,c=r[a.row][a.col],i=r[l.row][l.col];i?(r[l.row][l.col]={...c,state:SWAPPED},r[a.row][a.col]={...i,state:SWAPPED}):(r[l.row][l.col]={...c},r[a.row][a.col]=null,unmarkSwapped(r));let s=evaluateBoardState(r,o);!allowsOpponentWin(r,m,n)&&(s+=1e3),s>y&&(y=s,A=e)}return A};const o="\nA..B\n...B\nAAB.\nA..B\n..BB\nA.BB\nAAA.\n....".trim(),n={row:2,col:1},r={row:2,col:2},a=PLAYER_A;function l(e){for(let t=0;t<ROWS;t++){let o=`${t}: `;for(let n=0;n<COLS;n++){const r=e[t][n];if(r){const e=r.player===PLAYER_A?"A":"B";o+=(r.state===NORMAL?e:e.toLowerCase())+" "}else o+=". "}}}window.runBoardPositionTest=async function(){if("undefined"!=typeof window&&"undefined"!=typeof tf){let e=0;for(;!window.tfModel&&e<100;)await new Promise((e=>setTimeout(e,100))),e++;window.tfModel}const e=parseStartingPosition(o);l(e);const t=checkWinCondition(e,PLAYER_A),c=checkWinCondition(e,PLAYER_B);if(t.win||c.win)return console.error("ERROR: Game already over in initial position!"),!1;!function(e){const t=cloneBoard(e),o=t[n.row][n.col];if(!o)return null;if(o.player!==a)return null;if(r.row<0||r.row>=ROWS||r.col<0||r.col>=COLS)return null;if(t[r.row][r.col]&&t[r.row][r.col].player===o.player)return null;const c=t[r.row][r.col];if(c)t[r.row][r.col]={...o,state:SWAPPED},t[n.row][n.col]={...c,state:SWAPPED};else{t[r.row][r.col]={...o},t[n.row][n.col]=null;for(let e=0;e<ROWS;e++)for(let o=0;o<COLS;o++)t[e][o]&&t[e][o].state===SWAPPED&&(t[e][o].state=NORMAL)}l(t);const i=a===PLAYER_A?PLAYER_B:PLAYER_A,s=canWinInOneMove(t,i);if(s.canWin)return t}(e);return await async function(e){const t=[];for(let o=0;o<ROWS;o++)for(let n=0;n<COLS;n++){const r=e[o][n];if(r&&r.player===PLAYER_B)for(let r=-1;r<=1;r++)for(let a=-1;a<=1;a++){if(0===r&&0===a)continue;const l=o+r,c=n+a;if(l>=0&&l<ROWS&&c>=0&&c<COLS){const r=e[l][c];r?r.player===PLAYER_A&&r.state===NORMAL&&t.push({start:{row:o,col:n},end:{row:l,col:c},type:"swap"}):t.push({start:{row:o,col:n},end:{row:l,col:c},type:"empty"})}}}t.slice(0,10).forEach(((e,t)=>{}));let o=0,n=0;for(let r=0;r<Math.min(t.length,15);r++){const a=t[r],l=cloneBoard(e),c=l[a.start.row][a.start.col],i=l[a.end.row][a.end.col];if("empty"===a.type){l[a.end.row][a.end.col]={...c},l[a.start.row][a.start.col]=null;for(let e=0;e<ROWS;e++)for(let t=0;t<COLS;t++)l[e][t]&&l[e][t].state===SWAPPED&&(l[e][t].state=NORMAL)}else l[a.end.row][a.end.col]={...c,state:SWAPPED},l[a.start.row][a.start.col]={...i,state:SWAPPED};canWinInOneMove(l,PLAYER_A).canWin?n++:o++}}(e),await async function(e){try{const t="undefined"!=typeof window&&"undefined"!=typeof tf,o=t?["easy","hard1","hard_ai"]:["easy","hard1"];!t;for(const n of o){"hard_ai"===n&&window.tfModel;const o=await findBestAIMove(e,PLAYER_B,n,2,!0,!1,50,t?window.tfModel:null,null,null);if(o){const t=cloneBoard(e),n=t[o.start.row][o.start.col],r=t[o.end.row][o.end.col];if(r)t[o.end.row][o.end.col]={...n,state:SWAPPED},t[o.start.row][o.start.col]={...r,state:SWAPPED};else{t[o.end.row][o.end.col]={...n},t[o.start.row][o.start.col]=null;for(let e=0;e<ROWS;e++)for(let o=0;o<COLS;o++)t[e][o]&&t[e][o].state===SWAPPED&&(t[e][o].state=NORMAL)}canWinInOneMove(t,PLAYER_A).canWin}}!t}catch(e){console.error("Error testing AI move selection:",e)}}(e),!0};let c,i=[],s=PLAYER_A,d=null,u=[],w=[],f=!1,A=null,y=[],m=0,p=0,S=null,h=0,E=!1,P=null,v=null,g="easy",L=!1,B=!0,O=50,R=.1,I=.25,M=!1,b=null,C=null,_=!1;window.analysisMode=L;const W=document.getElementById("game-board"),T=document.getElementById("reset-btn"),N=document.getElementById("info-btn"),k=document.getElementById("history-btn"),Y=document.getElementById("start-btn"),D=document.getElementById("info-overlay"),x=document.getElementById("history-overlay"),H=document.getElementById("win-overlay"),F=document.getElementById("history-list"),$=document.getElementById("win-message"),J=document.querySelectorAll(".close-overlay-btn"),U=document.querySelectorAll(".overlay"),j=(document.getElementById("ai-spinner-overlay"),document.getElementById("mcts-btn")),z=document.getElementById("mcts-overlay");function G(){"undefined"!=typeof MCTSSearch&&"undefined"!=typeof SwitcharooGameLogic?(C=new SwitcharooGameLogic({ROWS:ROWS,COLS:COLS,PLAYER_A:PLAYER_A,PLAYER_B:PLAYER_B,NORMAL:NORMAL,SWAPPED:SWAPPED,NUM_DIRECTIONS:NUM_DIRECTIONS,JS_DIRECTIONS:JS_DIRECTIONS}),b=new MCTSSearch({numSimulations:O,cPuct:1,temperature:R,dirichletAlpha:.3,dirichletEpsilon:I,enabled:B,verbose:M,logSearchStats:!0}),window.mctsSearch=b,window.gameLogic=C,console.log("MCTS initialized with settings:",{numSimulations:O,cPuct:1,temperature:R,dirichletAlpha:.3,dirichletEpsilon:I,enabled:B,verbose:M})):(console.warn("MCTS classes not available - MCTS features disabled"),window.mctsSearch=null,window.gameLogic=null)}function q(){E&&de(),S=parseStartingPosition(initialPosition[h]),i=S.map((e=>e.map((e=>e?{...e}:null)))),s=PLAYER_A,d=null,u=[],w=[],f=!1,A=null,y=[],k.disabled=!0,renderBoard({board:i,selectedPiece:d,legalMoves:u,gameOver:f,winner:A,winPath:y,moveHistory:w,currentHistoryIndex:c,playerAScore:m,playerBScore:p,boardElement:W,currentPlayer:s}),hideAllOverlays(),_&&0===w.length&&(s=PLAYER_B,setTimeout((async()=>{await ne(),s=PLAYER_A,renderBoard({board:i,selectedPiece:d,legalMoves:u,gameOver:f,winner:A,winPath:y,moveHistory:w,currentHistoryIndex:c,playerAScore:m,playerBScore:p,boardElement:W,currentPlayer:s})}),300))}function K(){const e=document.getElementById("control-score-a"),t=document.getElementById("control-score-b");e&&(e.textContent=`${m}`),t&&(t.textContent=`${p}`);const o=document.getElementById("score-a"),n=document.getElementById("score-b");o&&n&&(o.textContent=`Player A: ${m}`,n.textContent=`Player B: ${p}`)}function V(e){if(!f)return;void 0===c&&(c=w.length);const t=Math.max(0,Math.min(w.length,c+e));if(t!==c){if(c=t,c===w.length)ie({board:i,selectedPiece:d,legalMoves:u,gameOver:f,winner:A,winPath:y,moveHistory:w,currentHistoryIndex:c,playerAScore:m,playerBScore:p,boardElement:W,currentPlayer:s});else if(0===c){ie({board:S.map((e=>e.map((e=>e?{...e}:null)))),selectedPiece:null,legalMoves:[],gameOver:f,winner:A,winPath:y,moveHistory:w,currentHistoryIndex:c,playerAScore:m,playerBScore:p,boardElement:W,currentPlayer:s})}else ie({board:w[c-1].boardAfter,selectedPiece:null,legalMoves:[],gameOver:f,winner:A,winPath:y,moveHistory:w,currentHistoryIndex:c,playerAScore:m,playerBScore:p,boardElement:W,currentPlayer:s});X()}}function X(){if(!f)return;let e=document.querySelector(".move-counter");e||(e=document.createElement("div"),e.classList.add("move-counter"),W.appendChild(e)),e.textContent=void 0===c||c===w.length?"Final Position":`Move ${c} of ${w.length}`}function Q(e,t,o,n,r){w.push({player:e,start:{...t},end:{...o},boardBefore:cloneBoard(n),boardAfter:cloneBoard(r)})}!async function(){if("undefined"!=typeof tf){const e=Object.keys(tf.engine().registryFactory);if(e.includes("webgl"))try{await tf.setBackend("webgl"),console.log("TensorFlow.js using WebGL backend for best performance")}catch(e){console.warn("WebGL backend failed, falling back to alternatives:",e)}else if(e.includes("wasm"))try{await tf.setBackend("wasm"),console.log("TensorFlow.js using WASM backend for improved CPU performance")}catch(e){console.warn("WASM backend failed, falling back to CPU:",e),await tf.setBackend("cpu"),console.log("TensorFlow.js using CPU backend")}else await tf.setBackend("cpu");await tf.ready()}else console.warn("tf object not available at the time of setting backend.")}(),document.addEventListener("DOMContentLoaded",(async()=>{G(),await new Promise((e=>setTimeout(e,500)));try{await async function(e=3e4){const t=Date.now();let o=0;for(;"undefined"==typeof tf;){if(o++,Date.now()-t>e)throw console.error(`TensorFlow.js failed to load within ${e}ms timeout after ${o} attempts`),new Error("TensorFlow.js failed to load within timeout");o%10==0,await new Promise((e=>setTimeout(e,200)))}return!0}();await async function(){try{if("undefined"==typeof tf)throw new Error("TensorFlow.js not available yet");let e;await tf.ready();try{e=await tf.loadGraphModel("./switcharoo_tfjs_model/model.json")}catch(e){throw console.error("Error during tf.loadGraphModel:",e),console.error("Model load error type:",e.constructor.name),console.error("Model load error message:",e.message),console.error("Model load error stack:",e.stack),e}v=e;try{const e=tf.zeros([1,8,4,18]),t=v.inputs[0].name,o=v.execute({[t]:e});Array.isArray(o)?o.forEach((e=>e.dispose())):o&&"function"==typeof o.dispose&&o.dispose(),e.dispose()}catch(e){console.error("Model test failed:",e)}return window.tfModel=v,!0}catch(e){return console.error("=== Model Loading Failed ==="),console.error("Could not load pre-trained graph model. Error object:",e),console.error("Error type:",e.constructor.name),console.error("Error message:",e.message),console.error("Error stack:",e.stack),console.warn("The Neural Network AI option will be disabled as it requires pre-trained weights to work properly."),v=null,window.tfModel=null,!1}}()}catch(e){console.warn("Failed to wait for TensorFlow.js or load model:",e),console.warn("Error details:",e.message,e.stack),window.tfModel=null}const e=document.getElementById("ai-plays-first");e&&(e.checked=_,e.addEventListener("change",(()=>{_=e.checked}))),q()})),T.addEventListener("click",(()=>{h=0,q()})),N.addEventListener("click",(()=>showOverlay(D))),k.addEventListener("click",(()=>{k.disabled||(!function(){if(F.innerHTML="",0===w.length)return F.textContent="No moves made yet.",void 0;for(let e=w.length-1;e>=0;e--){const t=w[e],o=e+1,n=ROWS-t.start.row,r=ROWS-t.end.row,a=String.fromCharCode("A".charCodeAt(0)+t.start.col),l=String.fromCharCode("A".charCodeAt(0)+t.end.col),i=document.createElement("div");i.textContent=`${o}. Player ${t.player}: ${a}${n} → ${l}${r}`,i.classList.add("history-move"),c===o&&i.classList.add("selected-move"),i.addEventListener("click",(()=>{c=o,t.boardAfter?ie({board:t.boardAfter,selectedPiece:null,legalMoves:[],gameOver:f,winner:A,winPath:y,moveHistory:w,currentHistoryIndex:c,playerAScore:m,playerBScore:p,boardElement:W,currentPlayer:s}):console.warn("No boardAfter for move",o),X(),hideOverlay(x)})),F.appendChild(i)}const e=document.createElement("div");e.textContent="0. Initial State",e.classList.add("history-move"),0===c&&e.classList.add("selected-move"),e.addEventListener("click",(()=>{const e=S.map((e=>e.map((e=>e?{...e}:null))));c=0,ie({board:e,selectedPiece:null,legalMoves:[],gameOver:f,winner:A,winPath:y,moveHistory:w,currentHistoryIndex:c,playerAScore:m,playerBScore:p,boardElement:W,currentPlayer:s}),X(),hideOverlay(x)})),F.insertBefore(e,F.firstChild)}(),showOverlay(x))})),Y.addEventListener("click",(()=>{h=(h+1)%initialPosition.length,q()})),J.forEach((e=>{e.addEventListener("click",(async()=>{const t=e.getAttribute("data-overlay"),o=document.getElementById(t);hideOverlay(o),"mcts-overlay"===t&&void 0!==_&&_&&Array.isArray(w)&&0===w.length&&void 0!==s&&s===PLAYER_A&&(s=PLAYER_B,await ne(),s=PLAYER_A,renderBoard({board:i,selectedPiece:d,legalMoves:u,gameOver:f,winner:A,winPath:y,moveHistory:w,currentHistoryIndex:c,playerAScore:m,playerBScore:p,boardElement:W,currentPlayer:s}))}))})),U.forEach((e=>{e.addEventListener("click",(t=>{t.target===e&&hideOverlay(e)}))})),j&&z&&j.addEventListener("click",(()=>{showOverlay(z)}));const Z=document.getElementById("ai-difficulty-select");function ee(){const e=document.querySelectorAll(".mcts-only"),t=document.getElementById("mcts-enabled");Z&&"hard_ai"===Z.value?(e.forEach((e=>e.style.display="")),B=!0,t&&(t.checked=!0,t.dispatchEvent(new Event("change",{bubbles:!0})))):(e.forEach((e=>e.style.display="none")),B=!1,t&&(t.checked=!1,t.dispatchEvent(new Event("change",{bubbles:!0})))),te()}function te(){const e=document.getElementById("mcts-enabled"),t=document.getElementById("mcts-simulations"),o=document.getElementById("mcts-simulations-value"),n=document.getElementById("mcts-temperature"),r=document.getElementById("mcts-temperature-value");e&&(e.checked=B),t&&(t.value=O),o&&(o.textContent=O),n&&(n.value=R),r&&(r.textContent=R.toFixed(2))}function oe(){const e=document.getElementById("mcts-btn"),t=e?.querySelector("img");if(t)switch(Z.value){case"easy":default:t.src="images/happy-outline.svg";break;case"hard1":t.src="images/hardware-chip-outline.svg";break;case"hard_ai":t.src="images/skull-outline.svg"}}async function ne(){if(f)return;(()=>{const e=[];for(w&&w.length>=2&&e.push(w[w.length-2].boardAfter),w&&w.length>=1&&e.push(w[w.length-1].boardAfter);e.length<2;)e.unshift(null);e.push(i)})();const e=await findBestAIMove(i,s,g,1,window.analysisMode,B,O,v,b,C,w);if(e){const t=cloneBoard(i);i=makeMove(e.start.row,e.start.col,e.end.row,e.end.col,i,e.start,[e.end],s),Q(s,e.start,e.end,t,i);const o=checkWinCondition(i,PLAYER_A),n=checkWinCondition(i,PLAYER_B);o.win||n.win?(f=!0,A=o.win&&n.win?"both":o.win?PLAYER_A:PLAYER_B,y=o.win?o.path:n.path,A===PLAYER_A?m++:A===PLAYER_B&&p++,H&&$&&($.textContent="both"===A?"Both players win simultaneously!":`Player ${A===PLAYER_A?"A":"B"} wins!`,showOverlay(H)),k&&(k.disabled=!1)):s=switchPlayer(s),ie({board:i,selectedPiece:d,legalMoves:u,gameOver:f,winner:A,winPath:y,moveHistory:w,currentHistoryIndex:c,playerAScore:m,playerBScore:p,boardElement:W,currentPlayer:s}),K()}else s=switchPlayer(s),ie({board:i,selectedPiece:d,legalMoves:u,gameOver:f,winner:A,winPath:y,moveHistory:w,currentHistoryIndex:c,playerAScore:m,playerBScore:p,boardElement:W,currentPlayer:s}),K()}Z&&(Z.addEventListener("change",(()=>{g=Z.value,ee()})),ee()),document.addEventListener("DOMContentLoaded",(()=>{if(!function(){const e=document.getElementById("mcts-simulations"),t=document.getElementById("mcts-simulations-value"),o=document.getElementById("mcts-temperature"),n=document.getElementById("mcts-temperature-value"),r=document.getElementById("mcts-enabled"),a=document.getElementById("mcts-reset-defaults");e&&t&&e.addEventListener("input",(e=>{const o=parseInt(e.target.value);O=Math.max(1,Math.min(200,o)),t.textContent=O,b&&b.setNumSimulations(O)})),o&&n&&o.addEventListener("input",(e=>{const t=parseFloat(e.target.value);R=Math.max(0,Math.min(2,t)),n.textContent=R.toFixed(2),b&&b.setTemperature(R)})),r&&r.addEventListener("change",(e=>{Z&&"hard_ai"===Z.value?(B=e.target.checked,b&&b.setEnabled(B)):(e.target.checked=!1,B=!1)})),a&&a.addEventListener("click",(()=>{B=!0,O=50,R=.1,M=!1,te(),G()}))}(),te(),Z&&"hard_ai"===Z.value){B=!0;const e=document.getElementById("mcts-enabled");e&&(e.checked=!0,e.dispatchEvent(new Event("change",{bubbles:!0})))}})),Z&&(Z.addEventListener("change",oe),oe()),W&&W.addEventListener("click",(e=>{const t=e.target.closest(".cell");if(!t)return;const o=parseInt(t.dataset.row,10),n=parseInt(t.dataset.col,10);if(!isNaN(o)&&!isNaN(n)&&!f&&!E&&(s!==PLAYER_B||E))if(d)if(u.some((e=>e.row===o&&e.col===n))){const e=cloneBoard(i);i=makeMove(d.row,d.col,o,n,i,d,u,s),Q(s,d,{row:o,col:n},e,i),d=null,u=[];const t=checkWinCondition(i,PLAYER_A),r=checkWinCondition(i,PLAYER_B);t.win||r.win?(f=!0,A=t.win&&r.win?"both":t.win?PLAYER_A:PLAYER_B,y=t.win?t.path:r.path,A===PLAYER_A?m++:A===PLAYER_B&&p++,H&&$&&($.textContent="both"===A?"Both players win simultaneously!":`Player ${A===PLAYER_A?"A":"B"} wins!`,showOverlay(H)),k&&(k.disabled=!1)):(s=switchPlayer(s),s!==PLAYER_B||E||setTimeout(ne,100)),ie({board:i,selectedPiece:d,legalMoves:u,gameOver:f,winner:A,winPath:y,moveHistory:w,currentHistoryIndex:c,playerAScore:m,playerBScore:p,boardElement:W,currentPlayer:s}),K()}else o===d.row&&n===d.col?(d=null,u=[],ie({board:i,selectedPiece:d,legalMoves:u,gameOver:f,winner:A,winPath:y,moveHistory:w,currentHistoryIndex:c,playerAScore:m,playerBScore:p,boardElement:W,currentPlayer:s})):i[o][n]&&i[o][n].player===s?(d={row:o,col:n},u=calculateLegalMoves(o,n,i,s),ie({board:i,selectedPiece:d,legalMoves:u,gameOver:f,winner:A,winPath:y,moveHistory:w,currentHistoryIndex:c,playerAScore:m,playerBScore:p,boardElement:W,currentPlayer:s})):(d=null,u=[],ie({board:i,selectedPiece:d,legalMoves:u,gameOver:f,winner:A,winPath:y,moveHistory:w,currentHistoryIndex:c,playerAScore:m,playerBScore:p,boardElement:W,currentPlayer:s}));else i[o][n]&&i[o][n].player===s&&(d={row:o,col:n},u=calculateLegalMoves(o,n,i,s),ie({board:i,selectedPiece:d,legalMoves:u,gameOver:f,winner:A,winPath:y,moveHistory:w,currentHistoryIndex:c,playerAScore:m,playerBScore:p,boardElement:W,currentPlayer:s}))})),W.addEventListener("wheel",(e=>{if(!f)return;e.preventDefault();V(e.deltaY>0?-1:1)}));let re=null;W.addEventListener("touchstart",(e=>{f&&1===e.touches.length&&(re=e.touches[0].clientY)})),W.addEventListener("touchend",(e=>{if(!f||null===re)return;const t=e.changedTouches[0].clientY-re;if(Math.abs(t)>30){V(t<0?1:-1)}re=null}));var ae=!0,le=console.log;console.log=function(){ae,le.apply(this,arguments)};var ce=console.warn;function ie(e){renderBoard({...e,showWinPath:void 0===c||c===w.length,boardElement:W})}async function se(){if(void 0!==c&&c>0){const e=w[c-1].boardAfter,t=w[c-1].player===PLAYER_A?PLAYER_B:PLAYER_A;L=!0;await findBestAIMove(e,t,g,1,!0,B,O,v,b,C);L=!1}}function de(){E=!1,P&&(clearTimeout(P),P=null)}function ue(){if(!E||f)return;P=setTimeout((()=>{!async function(){if(!E||f)return;try{await ne(),!f&&E?ue():f&&de()}catch(e){console.error("Error during self-play move:",e),de()}}()}),500)}console.warn=function(){ae,ce.apply(this,arguments)},window.SwitcharooGlobals={board:i,currentPlayer:s,selectedPiece:d,legalMoves:u,moveHistory:w,gameOver:f,winner:A,winPath:y,playerAScore:m,playerBScore:p,currentHistoryIndex:c,startingPosition:S,startingPositionIndex:h,isInSelfPlay:E,selfPlayTimeoutId:P,tfModel:v,AI_DIFFICULTY:g,AI_DEPTH:1,ANALYSIS_MODE:L,MCTS_ENABLED:B,MCTS_SIMULATIONS:O,MCTS_TEMPERATURE:R,MCTS_PUCT_CONSTANT:1,MCTS_DIRICHLET_ALPHA:.3,MCTS_DIRICHLET_EPSILON:I,MCTS_VERBOSE:M,mctsSearch:b,gameLogic:C,parseStartingPosition:parseStartingPosition,cloneBoard:cloneBoard,serializeBoardState:serializeBoardState,boardToKey:boardToKey,convertBoardToBinaryJS:convertBoardToBinaryJS,renderBoard:renderBoard,getPieceImage:getPieceImage,selectPiece:selectPiece,deselectPiece:deselectPiece,calculateLegalMoves:calculateLegalMoves,makeMove:makeMove,unmarkSwapped:unmarkSwapped,switchPlayer:switchPlayer,checkWinCondition:checkWinCondition,boardToNNInput:boardToNNInput,neuralNetworkPredict:neuralNetworkPredict,initializeMCTS:G,showOverlay:showOverlay,hideOverlay:hideOverlay,hideAllOverlays:hideAllOverlays,initGame:q,findBestAIMove:findBestAIMove,moveToActionIndex:moveToActionIndex,calculateLegalMovesForState:calculateLegalMovesForState,allowsOpponentWin:allowsOpponentWin,evaluateBoardState:evaluateBoardState,countFriendlyNeighbors:countFriendlyNeighbors,checkWinConditionForState:checkWinConditionForState,analyzeHistoricalMove:se,startSelfPlay:function(){if(f)return;E=!0,ue()},stopSelfPlay:de},window.analyzeHistoricalMove=se,window.printBoardState=function(){return void 0===i?(console.warn("Global board variable is not defined."),void 0):(logBoardForDebug(i),i)}}();